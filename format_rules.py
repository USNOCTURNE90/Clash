# 从Surge自动同步 - 2025-05-06 08:56:54 (北京时间)
# 原始文件: format_rules.py
rules:
  - PROCESS-NAME,import os
  - PROCESS-NAME,import re
  - PROCESS-NAME,import time
  - PROCESS-NAME,import subprocess
  - PROCESS-NAME,from pathlib import Path
  - PROCESS-NAME,import logging
  - PROCESS-NAME,import traceback
  - PROCESS-NAME,from datetime import datetime, timedelta
  - PROCESS-NAME,import ipaddress
  - DOMAIN-SUFFIX,logging.basicConfig(
  - DOMAIN-SUFFIX,level=logging.INFO,
  - PROCESS-NAME,format="%(asctime)s - %(levelname)s - %(message)s"
  - PROCESS-NAME,)
  - DOMAIN-SUFFIX,logger = logging.getLogger(__name__)
  - PROCESS-NAME,def get_china_time():
  - DOMAIN-SUFFIX,utc_now = datetime.utcnow()
  - PROCESS-NAME,china_time = utc_now + timedelta(hours=8)
  - DOMAIN-SUFFIX,return china_time.strftime('%Y-%m-%d %H:%M:%S')
  - PROCESS-NAME,def process_rule_line(line, is_surge=True):
  - DOMAIN-SUFFIX,line = line.strip()
  - DOMAIN-SUFFIX,if not line or line.startswith("#"):
  - PROCESS-NAME,return line
  - PROCESS-NAME,known_prefixes = ["DOMAIN-SUFFIX,", "DOMAIN-KEYWORD,", "DOMAIN,", "IP-CIDR,", "IP-ASN,", "PROCESS-NAME,"]
  - DOMAIN-SUFFIX,if any(line.startswith(prefix) for prefix in known_prefixes):
  - PROCESS-NAME,return line
  - DOMAIN-SUFFIX,if "." in line:
  - PROCESS-NAME,try:
  - DOMAIN-SUFFIX,parts = line.split('.')
  - DOMAIN-SUFFIX,if all(part.isdigit() for part in parts):
  - DOMAIN-SUFFIX,ipaddress.ip_address(line)
  - PROCESS-NAME,return f"IP-CIDR,{line}/32" if is_surge else f"- IP-CIDR,{line}/32"
  - PROCESS-NAME,else:
  - PROCESS-NAME,return f"DOMAIN-SUFFIX,{line}" if is_surge else f"- DOMAIN-SUFFIX,{line}"
  - PROCESS-NAME,except ValueError:
  - PROCESS-NAME,return f"DOMAIN-SUFFIX,{line}" if is_surge else f"- DOMAIN-SUFFIX,{line}"
  - PROCESS-NAME,else:
  - PROCESS-NAME,return f"PROCESS-NAME,{line}" if is_surge else f"- PROCESS-NAME,{line}"
  - DOMAIN-SUFFIX,print(f"Current directory: {os.getcwd()}")
  - DOMAIN-SUFFIX,print(f"Directory contents: {os.listdir('.')}")
  - PROCESS-NAME,try:
  - DOMAIN-SUFFIX,root_dir = Path(".")
  - PROCESS-NAME,exclude_patterns = [
  - DOMAIN-SUFFIX,'.git', '.github', 'Clash', '*.yml', '*.yaml', '*.py', '*.md',
  - DOMAIN-SUFFIX,'.gitignore', 'LICENSE', 'README*'
  - PROCESS-NAME,]
  - PROCESS-NAME,def should_exclude(path):
  - PROCESS-NAME,"""判断文件是否应被排除处理"""
  - PROCESS-NAME,path_str = str(path)
  - DOMAIN-SUFFIX,if path.is_dir():
  - PROCESS-NAME,return True
  - DOMAIN-SUFFIX,if path.name.startswith('.'):
  - PROCESS-NAME,return True
  - PROCESS-NAME,for pattern in exclude_patterns:
  - PROCESS-NAME,if '*' in pattern:
  - DOMAIN-SUFFIX,suffix = pattern.replace('*', '')
  - DOMAIN-SUFFIX,if path_str.endswith(suffix):
  - PROCESS-NAME,return True
  - PROCESS-NAME,elif pattern in path_str:
  - PROCESS-NAME,return True
  - PROCESS-NAME,return False
  - PROCESS-NAME,rule_files = []
  - DOMAIN-SUFFIX,for file_path in root_dir.glob('*'):
  - PROCESS-NAME,if should_exclude(file_path):
  - PROCESS-NAME,print(f"Skipping excluded file: {file_path}")
  - PROCESS-NAME,continue
  - PROCESS-NAME,try:
  - PROCESS-NAME,with open(file_path, "r", encoding="utf-8") as f:
  - DOMAIN-SUFFIX,content = f.read()
  - DOMAIN-SUFFIX,if "DOMAIN" in content or "IP-CIDR" in content or "." in content:
  - DOMAIN-SUFFIX,rule_files.append(file_path)
  - DOMAIN-SUFFIX,print(f"Found rule file: {file_path.name}")
  - PROCESS-NAME,except Exception as e:
  - DOMAIN-SUFFIX,print(f"Error reading {file_path.name}: {str(e)}")
  - PROCESS-NAME,if not rule_files:
  - PROCESS-NAME,print("No rule files found!")
  - DOMAIN-SUFFIX,print(f"All files: {[f.name for f in root_dir.glob('*') if not should_exclude(f)]}")
  - PROCESS-NAME,exit(1)
  - PROCESS-NAME,for rule_file in rule_files:
  - PROCESS-NAME,with open(rule_file, "r", encoding="utf-8") as f:
  - DOMAIN-SUFFIX,content = f.read()
  - PROCESS-NAME,current_time = get_china_time()
  - DOMAIN-SUFFIX,content_lines = content.splitlines()
  - PROCESS-NAME,updated_lines = []
  - PROCESS-NAME,time_comment_found = False
  - PROCESS-NAME,for line in content_lines:
  - DOMAIN-SUFFIX,if line.startswith("# 最后更新时间:"):
  - DOMAIN-SUFFIX,updated_lines.append(f"# 最后更新时间: {current_time} (北京时间)")
  - PROCESS-NAME,time_comment_found = True
  - PROCESS-NAME,else:
  - PROCESS-NAME,processed_line = process_rule_line(line, is_surge=True)
  - DOMAIN-SUFFIX,updated_lines.append(processed_line)
  - PROCESS-NAME,if not time_comment_found:
  - DOMAIN-SUFFIX,updated_lines.insert(0, f"# 最后更新时间: {current_time} (北京时间)")
  - DOMAIN-SUFFIX,updated_content = "\n".join(updated_lines)
  - PROCESS-NAME,if content != updated_content:
  - PROCESS-NAME,with open(rule_file, "w", encoding="utf-8") as f:
  - DOMAIN-SUFFIX,f.write(updated_content)
  - DOMAIN-SUFFIX,print(f"Updated rule file: {rule_file.name}")
  - DOMAIN-SUFFIX,subprocess.run(["git", "add", "."], check=True)
  - DOMAIN-SUFFIX,result = subprocess.run(
  - PROCESS-NAME,["git", "status", "--porcelain"],
  - PROCESS-NAME,capture_output=True,
  - PROCESS-NAME,text=True,
  - PROCESS-NAME,check=True
  - PROCESS-NAME,)
  - DOMAIN-SUFFIX,if result.stdout.strip():
  - DOMAIN-SUFFIX,print("Changes found in current repo, committing...")
  - PROCESS-NAME,china_time = get_china_time()
  - PROCESS-NAME,commit_message = f"[AUTO_FORMAT] 自动格式化规则集 - {china_time} (北京时间)"
  - DOMAIN-SUFFIX,subprocess.run(
  - PROCESS-NAME,["git", "commit", "-m", commit_message],
  - PROCESS-NAME,check=True
  - PROCESS-NAME,)
  - DOMAIN-SUFFIX,print("Pushing changes to current repo...")
  - DOMAIN-SUFFIX,subprocess.run(["git", "push"], check=True)
  - PROCESS-NAME,print("Successfully updated current repo")
  - PROCESS-NAME,else:
  - PROCESS-NAME,print("No changes to commit in current repo")
  - PROCESS-NAME,except Exception as e:
  - PROCESS-NAME,print(f"Error: {str(e)}")
  - DOMAIN-SUFFIX,traceback.print_exc()
  - PROCESS-NAME,exit(1)