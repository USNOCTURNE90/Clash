name: Sync Rules

on:
  push:
    branches:
      - main
      - master
      - Surge
    paths:
      - '**'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.PAT }}
          fetch-depth: 2
          
      - name: Check commit message
        id: check_commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ $COMMIT_MSG == *"[AUTO_SYNC]"* ]]; then
            echo "Skipping workflow as this is an automated sync commit"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Proceeding with sync"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Set up Python
        if: steps.check_commit.outputs.skip == 'false'
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'
          
      - name: Install dependencies
        if: steps.check_commit.outputs.skip == 'false'
        run: |
          python -m pip install --upgrade pip
          
      - name: Configure Git
        if: steps.check_commit.outputs.skip == 'false'
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
      - name: Debug environment
        if: steps.check_commit.outputs.skip == 'false'
        run: |
          echo "Current directory:"
          pwd
          echo "Directory contents:"
          ls -la
          
      - name: Create and run sync script
        if: steps.check_commit.outputs.skip == 'false'
        run: |
          cat > sync_rules.py << 'EOF'
          #!/usr/bin/env python3

          import os
          import re
          import time
          import subprocess
          from pathlib import Path
          import logging
          import traceback
          from datetime import datetime, timedelta
          import ipaddress
          
          # 配置日志
          logging.basicConfig(
              level=logging.INFO,
              format="%(asctime)s - %(levelname)s - %(message)s"
          )
          logger = logging.getLogger(__name__)
          
          # 获取中国时间
          def get_china_time():
              utc_now = datetime.utcnow()
              china_time = utc_now + timedelta(hours=8)
              return china_time.strftime('%Y-%m-%d %H:%M:%S')
          
          # 检查和处理规则行
          def process_rule_line(line, is_surge=True):
              line = line.strip()
              if not line or line.startswith("#"):
                  return line
              
              # 检查是否已有前缀
              known_prefixes = ["DOMAIN-SUFFIX,", "DOMAIN-KEYWORD,", "DOMAIN,", "IP-CIDR,", "IP-ASN,", "PROCESS-NAME,"]
              if any(line.startswith(prefix) for prefix in known_prefixes):
                  return line
                  
              # 检查是否是域名（包含点）
              if "." in line:
                  try:
                      # 检查是否是纯数字IP
                      parts = line.split('.')
                      if all(part.isdigit() for part in parts):
                          # 尝试解析为IP地址
                          ipaddress.ip_address(line)
                          # 如果是有效IP，添加IP-CIDR前缀和/32
                          return f"IP-CIDR,{line}/32" if is_surge else f"- IP-CIDR,{line}/32"
                      else:
                          # 是域名，添加DOMAIN-SUFFIX前缀
                          return f"DOMAIN-SUFFIX,{line}" if is_surge else f"- DOMAIN-SUFFIX,{line}"
                  except ValueError:
                      # 不是有效IP，当作域名处理
                      return f"DOMAIN-SUFFIX,{line}" if is_surge else f"- DOMAIN-SUFFIX,{line}"
              else:
                  # 没有点，作为进程名处理
                  return f"PROCESS-NAME,{line}" if is_surge else f"- PROCESS-NAME,{line}"
          
          # 打印当前工作目录和内容
          print(f"Current directory: {os.getcwd()}")
          print(f"Directory contents: {list(Path('.').glob('*'))}")
          
          try:
              # 设置目录
              surge_dir = Path(".")
              clash_dir = Path("Clash")
              
              # 获取GitHub令牌
              github_token = os.environ.get("GITHUB_TOKEN", "")
              clash_repo = f"https://{github_token}@github.com/USNOCTURNE90/Clash.git"
              
              # 清理并克隆Clash仓库
              if clash_dir.exists():
                  import shutil
                  shutil.rmtree(clash_dir)
              
              print(f"Cloning repo: {clash_repo}")
              subprocess.run(["git", "clone", clash_repo, "Clash"], check=True)
              
              # 查找规则文件
              rule_files = []
              for file_path in surge_dir.glob("*"):
                  if not file_path.is_file() or file_path.name.startswith("."):
                      continue
                  
                  try:
                      with open(file_path, "r", encoding="utf-8") as f:
                          content = f.read()
                          if "DOMAIN" in content or "IP-CIDR" in content or "." in content:
                              rule_files.append(file_path)
                              print(f"Found rule file: {file_path.name}")
                  except Exception as e:
                      print(f"Error reading {file_path.name}: {str(e)}")
              
              if not rule_files:
                  print("No rule files found!")
                  print(f"All files: {list(surge_dir.glob('*'))}")
                  exit(1)
              
              # 处理规则文件
              for surge_file in rule_files:
                  with open(surge_file, "r", encoding="utf-8") as f:
                      surge_content = f.read()
                  
                  # 添加最后更新时间标记到文件内容
                  current_time = get_china_time()
                  surge_lines = surge_content.splitlines()
                  updated_surge_lines = []
                  
                  # 更新或添加最后更新时间注释
                  time_comment_found = False
                  for line in surge_lines:
                      if line.startswith("# 最后更新时间:"):
                          updated_surge_lines.append(f"# 最后更新时间: {current_time} (北京时间)")
                          time_comment_found = True
                      else:
                          # 处理规则行，添加适当的前缀
                          processed_line = process_rule_line(line, is_surge=True)
                          updated_surge_lines.append(processed_line)
                  
                  if not time_comment_found:
                      # 在文件开头添加更新时间
                      updated_surge_lines.insert(0, f"# 最后更新时间: {current_time} (北京时间)")
                  
                  # 更新Surge文件内容
                  updated_surge_content = "\n".join(updated_surge_lines)
                  with open(surge_file, "w", encoding="utf-8") as f:
                      f.write(updated_surge_content)
                  
                  # 将更改推送回Surge仓库
                  surge_changes = True
                  
                  # 转换为Clash格式
                  clash_rules = ["rules:"]
                  for line in updated_surge_content.split("\n"):
                      line = line.strip()
                      if not line or line.startswith("#"):
                          continue
                      
                      # 检查是否已经有前缀
                      if any(line.startswith(prefix) for prefix in ["DOMAIN-SUFFIX,", "DOMAIN-KEYWORD,", "DOMAIN,", "IP-CIDR,", "IP-ASN,", "PROCESS-NAME,"]):
                          clash_rules.append(f"  - {line}")
                      else:
                          # 没有前缀，处理并添加
                          processed_line = process_rule_line(line, is_surge=False)
                          clash_rules.append(f"  {processed_line}")
                  
                  # 添加注释
                  clash_content = f"# 从Surge自动同步 - {current_time} (北京时间)\n# 原始文件: {surge_file.name}\n" + "\n".join(clash_rules)
                  
                  # 写入Clash规则文件
                  clash_file = clash_dir / surge_file.name
                  with open(clash_file, "w", encoding="utf-8") as f:
                      f.write(clash_content)
                  
                  print(f"Synced rule file: {surge_file.name}")
              
              # 提交Surge仓库的更改
              print("Checking for changes in Surge repo...")
              subprocess.run(["git", "add", "."], check=True)
              
              surge_result = subprocess.run(
                  ["git", "status", "--porcelain"],
                  capture_output=True,
                  text=True,
                  check=True
              )
              
              if surge_result.stdout.strip():
                  print("Changes found in Surge repo, committing...")
                  china_time = get_china_time()
                  surge_commit_message = f"[AUTO_FORMAT] 自动格式化规则集 - {china_time} (北京时间)"
                  subprocess.run(
                      ["git", "commit", "-m", surge_commit_message],
                      check=True
                  )
                  
                  print("Pushing changes to Surge repo...")
                  subprocess.run(["git", "push"], check=True)
                  print("Successfully updated Surge repo")
              else:
                  print("No changes to commit in Surge repo")
              
              # 提交Clash仓库的更改
              print("Checking for changes in Clash repo...")
              subprocess.run(["git", "-C", "Clash", "add", "."], check=True)
              
              clash_result = subprocess.run(
                  ["git", "-C", "Clash", "status", "--porcelain"],
                  capture_output=True,
                  text=True,
                  check=True
              )
              
              if clash_result.stdout.strip():
                  print("Changes found in Clash repo, committing...")
                  china_time = get_china_time()
                  clash_commit_message = f"[AUTO_SYNC] 从Surge自动同步规则集 - {china_time} (北京时间)"
                  subprocess.run(
                      ["git", "-C", "Clash", "commit", "-m", clash_commit_message],
                      check=True
                  )
                  
                  print("Pushing changes to Clash repo...")
                  subprocess.run(["git", "-C", "Clash", "push"], check=True)
                  print("Successfully synced rules to Clash repo")
              else:
                  print("No changes to commit in Clash repo")
          
          except Exception as e:
              print(f"Error: {str(e)}")
              traceback.print_exc()
              exit(1)
          EOF
          
          chmod +x sync_rules.py
          python sync_rules.py
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
